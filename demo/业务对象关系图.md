# 售后单管理系统 - 业务对象关系图

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    售后单管理系统                              │
├─────────────────────────────────────────────────────────────┤
│  Controller Layer (控制器层)                                  │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │           AfterSalesController                          │ │
│  │  - 创建售后单 POST /api/after-sales/orders              │ │
│  │  - 查询列表   GET  /api/after-sales/orders              │ │
│  │  - 获取详情   GET  /api/after-sales/orders/{id}         │ │
│  │  - 审核售后单 PUT  /api/after-sales/orders/{id}/audit   │ │
│  │  - 获取统计   GET  /api/after-sales/statistics          │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Service Layer (服务层)                                      │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              AfterSalesService                          │ │
│  │  - createOrder()     创建售后单                         │ │
│  │  - queryOrders()     查询售后单列表                     │ │
│  │  - getOrderById()    根据ID获取详情                     │ │
│  │  - auditOrder()      审核售后单                         │ │
│  │  - canAudit()        检查是否可审核                     │ │
│  │  - isValidAuditStatus() 验证审核状态                    │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Data Storage (数据存储层)                                   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │         ConcurrentHashMap<String, AfterSalesOrder>      │ │
│  │                    (内存数组存储)                        │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 核心业务对象关系

### 1. 实体对象 (Entity)

#### AfterSalesOrder (售后单实体)
```
┌─────────────────────────────────────┐
│           AfterSalesOrder           │
├─────────────────────────────────────┤
│ - id: String                        │  主键ID (UUID)
│ - productName: String               │  商品名称
│ - storeName: String                 │  购买门店
│ - purchaseAmount: BigDecimal        │  购买金额
│ - purchaseTime: LocalDateTime       │  购买时间
│ - problemDescription: String        │  问题描述
│ - contactPhone: String              │  联系人电话
│ - status: OrderStatus               │  售后单状态
│ - createTime: LocalDateTime         │  创建时间
│ - updateTime: LocalDateTime         │  更新时间
│ - auditRemark: String               │  审核备注
│ - auditor: String                   │  审核人
│ - auditTime: LocalDateTime          │  审核时间
└─────────────────────────────────────┘
```

### 2. 枚举对象 (Enum)

#### OrderStatus (售后单状态枚举)
```
┌─────────────────────────────────────┐
│            OrderStatus              │
├─────────────────────────────────────┤
│ PENDING     - 待审核                │
│ APPROVED    - 已通过                │
│ REJECTED    - 已拒绝                │
│ PROCESSING  - 处理中                │
│ COMPLETED   - 已完成                │
│ CANCELLED   - 已取消                │
└─────────────────────────────────────┘
```

### 3. 数据传输对象 (DTO)

#### AfterSalesOrderCreateRequest (创建请求DTO)
```
┌─────────────────────────────────────┐
│   AfterSalesOrderCreateRequest      │
├─────────────────────────────────────┤
│ - productName: String               │  @NotBlank
│ - storeName: String                 │  @NotBlank
│ - purchaseAmount: BigDecimal        │  @NotNull @Positive
│ - purchaseTime: LocalDateTime       │  @NotNull
│ - problemDescription: String        │  @NotBlank
│ - contactPhone: String              │  @NotBlank @Pattern
└─────────────────────────────────────┘
```

#### AfterSalesOrderListResponse (列表响应DTO)
```
┌─────────────────────────────────────┐
│   AfterSalesOrderListResponse       │
├─────────────────────────────────────┤
│ - id: String                        │
│ - productName: String               │
│ - purchaseTime: LocalDateTime       │
│ - problemDescription: String        │
└─────────────────────────────────────┘
```

#### AuditRequest (审核请求DTO)
```
┌─────────────────────────────────────┐
│            AuditRequest             │
├─────────────────────────────────────┤
│ - status: OrderStatus               │  @NotNull
│ - auditor: String                   │  @NotBlank
│ - auditRemark: String               │  可选
└─────────────────────────────────────┘
```

## 业务流程关系图

### 售后单生命周期
```
创建售后单 → 待审核(PENDING) → 审核流程 → 最终状态
    │              │              │
    │              │              ├─ 已通过(APPROVED) → 处理中(PROCESSING) → 已完成(COMPLETED)
    │              │              │
    │              │              ├─ 已拒绝(REJECTED)
    │              │              │
    │              │              └─ 已取消(CANCELLED)
    │              │
    │              └─ 可重复审核（状态为PENDING或PROCESSING时）
    │
    └─ 自动生成ID、设置创建时间、初始状态为PENDING
```

### 审核流程控制
```
┌─────────────────────────────────────────────────────────────┐
│                      审核流程控制                              │
├─────────────────────────────────────────────────────────────┤
│  当前状态检查:                                                │
│  ├─ PENDING    ✓ 可以审核                                    │
│  ├─ PROCESSING ✓ 可以审核                                    │
│  ├─ APPROVED   ✗ 不可审核                                    │
│  ├─ REJECTED   ✗ 不可审核                                    │
│  ├─ COMPLETED  ✗ 不可审核                                    │
│  └─ CANCELLED  ✗ 不可审核                                    │
│                                                             │
│  目标状态验证:                                                │
│  ├─ APPROVED   ✓ 有效审核状态                                │
│  ├─ REJECTED   ✓ 有效审核状态                                │
│  ├─ PROCESSING ✓ 有效审核状态                                │
│  ├─ COMPLETED  ✓ 有效审核状态                                │
│  ├─ CANCELLED  ✓ 有效审核状态                                │
│  └─ PENDING    ✗ 无效审核状态                                │
└─────────────────────────────────────────────────────────────┘
```

## API接口关系图

```
前端应用
    │
    ├─ POST   /api/after-sales/orders           → 创建售后单
    │     └─ AfterSalesOrderCreateRequest → AfterSalesOrder
    │
    ├─ GET    /api/after-sales/orders           → 查询售后单列表
    │     └─ 查询参数: startTime, endTime, productName
    │     └─ 返回: List<AfterSalesOrderListResponse>
    │
    ├─ GET    /api/after-sales/orders/{id}      → 获取售后单详情
    │     └─ 返回: AfterSalesOrder
    │
    ├─ PUT    /api/after-sales/orders/{id}/audit → 审核售后单
    │     └─ AuditRequest → AfterSalesOrder
    │
    ├─ GET    /api/after-sales/orders/all       → 获取所有售后单
    │     └─ 返回: List<AfterSalesOrder>
    │
    ├─ GET    /api/after-sales/statistics       → 获取统计信息
    │     └─ 返回: 各状态售后单数量统计
    │
    └─ DELETE /api/after-sales/orders/clear     → 清空所有数据(测试用)
```

## 数据存储关系

```
内存存储 (ConcurrentHashMap)
┌─────────────────────────────────────┐
│  Key: String (售后单ID)              │
│  Value: AfterSalesOrder             │
├─────────────────────────────────────┤
│  线程安全保证                        │
│  支持并发读写操作                    │
│  数据持久化在应用运行期间             │
│  重启后数据丢失                      │
└─────────────────────────────────────┘
```

## 系统特性

1. **完整的实体设计**: 包含售后单所需的所有字段
2. **状态管理**: 完善的状态枚举和状态转换控制
3. **审核流程**: 防止重复操作和异常操作的控制机制
4. **数据验证**: 使用Bean Validation进行参数校验
5. **RESTful API**: 标准的REST接口设计
6. **线程安全**: 使用ConcurrentHashMap保证并发安全
7. **异常处理**: 完善的异常处理和错误信息返回